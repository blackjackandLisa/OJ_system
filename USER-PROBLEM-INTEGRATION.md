# 用户系统与题目系统集成说明

## 🔗 已完成的集成

### 1. 权限控制集成

#### 题目创建/编辑权限
**规则：** 只有老师和管理员可以创建和编辑题目

**实现：**
```python
# apps/problems/permissions.py
class IsTeacherOrAdmin(permissions.BasePermission):
    """老师或管理员权限"""
    # 读取：所有人可以
    # 创建/编辑：老师和管理员
```

**效果：**
- ✅ 学生：可以查看题目，不能创建/编辑
- ✅ 老师：可以创建和编辑自己的题目
- ✅ 管理员：可以创建和编辑所有题目

#### 代码提交权限
**规则：** 需要登录才能提交代码

**实现：**
```python
@login_required(login_url='/users/login/')
def problem_submit_view(request, pk):
    """题目提交页面（需要登录）"""
```

**效果：**
- ✅ 未登录用户：点击"提交代码"跳转到登录页
- ✅ 登录用户：直接进入代码编辑器
- ✅ 登录后自动返回原页面

### 2. UI集成

#### 题目详情页
**已添加：**
- ✅ 登录用户：显示"提交代码"按钮
- ✅ 未登录用户：显示"登录后提交"按钮
- ✅ 显示用户的做题状态（已通过/尝试中）

#### 题目列表页
**已添加：**
- ✅ 未登录用户：提示"登录或注册以保存做题记录"
- ✅ 登录用户：显示做题状态图标
- ✅ 筛选器可以根据用户状态筛选

#### 导航栏
**已添加：**
- ✅ 未登录：显示"登录"和"注册"按钮
- ✅ 已登录：显示用户名和"登出"按钮
- ✅ 老师/管理员：额外显示"管理后台"链接

### 3. 数据关联

#### 用户-题目状态
**模型：** `UserProblemStatus`

**功能：**
- ✅ 记录用户对每个题目的状态
- ✅ 统计提交次数和通过次数
- ✅ 记录首次通过时间

**自动更新：**
- 当用户提交代码时更新（待实现判题系统）
- 通过后自动标记为"已通过"

#### 用户-统计信息
**模型：** `UserProfile.total_submit`, `total_accepted`

**功能：**
- ✅ 记录用户总提交数
- ✅ 记录用户通过题目数
- ✅ 计算AC率

**自动更新：**
```python
# 调用方法更新统计
user.profile.update_stats()
```

## 🎯 权限矩阵

### API权限

| API | 学生 | 老师 | 管理员 |
|-----|:----:|:----:|:------:|
| GET /api/problems/ | ✅ | ✅ | ✅ |
| GET /api/problems/{id}/ | ✅ | ✅ | ✅ |
| POST /api/problems/ | ❌ | ✅ | ✅ |
| PUT /api/problems/{id}/ | ❌ | ✅自己的 | ✅所有 |
| DELETE /api/problems/{id}/ | ❌ | ✅自己的 | ✅所有 |
| GET /api/testcases/ | ❌ | ✅ | ✅ |
| GET /users/api/me/ | ✅ | ✅ | ✅ |
| POST /users/api/register/ | ✅ | ✅需邀请码 | ❌ |

### 页面权限

| 页面 | 未登录 | 学生 | 老师 | 管理员 |
|------|:------:|:----:|:----:|:------:|
| 题目列表 | ✅ | ✅ | ✅ | ✅ |
| 题目详情 | ✅ | ✅ | ✅ | ✅ |
| 提交代码 | ❌ | ✅ | ✅ | ✅ |
| 个人中心 | ❌ | ✅ | ✅ | ✅ |
| 我的班级 | ❌ | ❌ | ✅ | ✅ |
| 管理后台 | ❌ | ❌ | ✅ | ✅ |

## 🚀 用户流程示例

### 学生使用流程

```
1. 访问首页 → 点击"开始刷题"
   ↓
2. 看到题目列表（未登录也可以查看）
   ↓
3. 点击题目查看详情
   ↓
4. 点击"提交代码" → 跳转到登录页
   ↓
5. 注册账号（只需用户名+密码）
   ↓
6. 自动登录 → 跳转回提交页面
   ↓
7. 编写代码并提交
   ↓
8. 查看个人中心统计
```

### 老师使用流程

```
1. 访问注册页面
   ↓
2. 选择"老师"角色
   ↓
3. 填写：用户名+密码+手机号+邀请码
   ↓
4. 注册成功并登录
   ↓
5. 访问管理后台创建题目
   ↓
6. 管理自己的班级
   ↓
7. 查看学生提交记录
```

## 📊 功能对应表

### 题目管理

| 操作 | 访问方式 | 权限要求 |
|------|----------|----------|
| 查看题目列表 | `/problems/` | 所有人 |
| 查看题目详情 | `/problems/{id}/` | 所有人 |
| 创建题目 | `/admin/problems/problem/add/` | 老师/管理员 |
| 编辑题目 | `/admin/problems/problem/{id}/` | 老师/管理员 |
| 提交代码 | `/problems/{id}/submit/` | 需要登录 |

### 用户管理

| 操作 | 访问方式 | 权限要求 |
|------|----------|----------|
| 注册 | `/users/register/` | 未登录 |
| 登录 | `/users/login/` | 未登录 |
| 个人中心 | `/users/profile/` | 需要登录 |
| 修改密码 | 个人中心模态框 | 需要登录 |
| 管理用户 | `/admin/users/userprofile/` | 管理员 |
| 我的班级 | `/users/my-classes/` | 老师/管理员 |

## 🔧 代码修改总结

### 1. 新增权限类
```python
# apps/problems/permissions.py
- IsTeacherOrAdmin: 老师或管理员权限
- IsOwnerOrTeacherOrAdmin: 拥有者、老师或管理员权限
```

### 2. 更新视图
```python
# apps/problems/views.py
- ProblemViewSet: 使用IsTeacherOrAdmin权限
- problem_submit_view: 添加@login_required装饰器
```

### 3. 更新模板
```html
# templates/problems/problem_detail.html
- 添加登录状态判断
- 未登录显示"登录后提交"
- 已登录显示"提交代码"
```

### 4. 简化注册
```python
# apps/users/serializers.py
学生注册：用户名 + 密码
老师注册：用户名 + 密码 + 手机号 + 邀请码
```

## 🎯 下一步集成任务

### 待实现功能

#### 1. 提交记录系统
- [ ] 创建Submission模型
- [ ] 记录用户提交
- [ ] 显示提交历史
- [ ] 关联用户和题目

#### 2. 自动更新统计
- [ ] 提交时更新UserProblemStatus
- [ ] 通过时更新UserProfile统计
- [ ] 实时计算AC率

#### 3. 权限细化
- [ ] 老师只能编辑自己创建的题目
- [ ] 老师只能查看自己班级学生的提交
- [ ] 学生不能查看测试用例答案

#### 4. 班级功能
- [ ] 学生加入班级
- [ ] 老师查看班级统计
- [ ] 班级排行榜

## 🧪 测试步骤

### 1. 测试学生注册和登录
```bash
# 访问注册页面
http://your-server-ip:8000/users/register/

# 注册学生账号
用户名: student01
密码: 123456
确认密码: 123456

# 自动登录后访问题目
http://your-server-ip:8000/problems/
```

### 2. 测试权限控制
```bash
# 学生尝试创建题目（应该失败）
POST /problems/api/problems/
→ 403 Forbidden

# 老师创建题目（应该成功）
# 先注册老师账号（需要邀请码）
# 然后在管理后台创建题目
```

### 3. 测试提交权限
```bash
# 未登录访问提交页面
http://your-server-ip:8000/problems/1/submit/
→ 跳转到登录页

# 登录后访问
→ 显示代码编辑器
```

## 📝 集成检查清单

- [x] 创建权限类
- [x] 更新题目视图权限
- [x] 添加login_required装饰器
- [x] 更新题目详情模板
- [x] 更新题目列表模板
- [x] 更新导航栏
- [x] 简化注册流程
- [ ] 运行数据库迁移
- [ ] 测试学生注册
- [ ] 测试老师注册
- [ ] 测试权限控制

## 🔗 相关文档

- `USER-SYSTEM-DESIGN.md` - 用户系统设计
- `PROBLEM-SYSTEM-DESIGN.md` - 题目系统设计
- `setup-users.sh` - 用户系统设置脚本

---

**用户系统已成功集成到题目系统！** 🎉
